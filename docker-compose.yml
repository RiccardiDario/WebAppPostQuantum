services:
  cert-generator:
    image: openquantumsafe/oqs-ossl3:latest
    container_name: cert-generator
    volumes:
      - ./certs:/certs
      - ./utils/generate_certs.sh:/generate_certs.sh
      - ./utils/openssl.cnf:/openssl.cnf
    stdin_open: true
    tty: true
    entrypoint: ["/bin/sh", "/generate_certs.sh"]
    env_file:
      - ./utils/.env

  app:
    build:
      context: ./app
    container_name: flask_app
    ports:
     - "5000:5000"
    volumes:
      - ./app:/app

  nginx:
    image: openquantumsafe/nginx:latest
    container_name: nginx_pq
    ports:
      - "4433:4433"
      - "8080:8080"
    volumes:
      - ./utils/nginx.conf:/opt/nginx/nginx-conf/nginx.conf
      - ./certs:/opt/nginx/certs
    depends_on:
      cert-generator:
        condition: service_completed_successfully

  curl:
    image: openquantumsafe/curl:latest
    container_name: pq_curl
    depends_on:
      - nginx
    volumes:
      - ./certs:/opt/certs
    entrypoint: ["tail", "-f", "/dev/null"]
